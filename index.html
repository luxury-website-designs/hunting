<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Hunting Map - Eden, TX</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js and Plugins -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* CRITICAL FIX: Ensure the body and html tags take up the full height */
        html, body { 
            height: 100%; 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
        }
        /* CRITICAL FIX: The map container must have a defined height to render */
        #map { 
            width: 100%; 
            height: 100%; 
            z-index: 10; 
            cursor: crosshair; 
        }
        .leaflet-popup-content-wrapper { background-color: #2d3748; color: #f7fafc; border-radius: 8px; }
        .leaflet-popup-tip { background-color: #2d3748; }
        .leaflet-popup-close-button { color: #f7fafc !important; }
        .custom-blind-icon { text-align: center; color: #ffca28; font-size: 24px; }
        #compass {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 3px solid #fff;
        }
        #compass-arrow { font-size: 50px; color: #ef4444; transition: transform 0.3s ease-out; }
        #compass-distance { font-size: 18px; color: #fff; margin-top: 10px; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-800 text-white">

    <div id="map"></div>

    <!-- Main UI Panel -->
    <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 bg-gray-900 bg-opacity-80 p-4 rounded-xl shadow-lg flex flex-col items-center gap-3 w-11/12 max-w-lg">
        <h1 class="text-xl font-bold text-white">Hunting Property Navigator</h1>
        <div id="user-info" class="text-sm text-center text-gray-400"></div>
    </div>
    
    <!-- Tools Panel -->
    <div class="absolute top-24 left-4 z-20 bg-gray-900 bg-opacity-80 p-3 rounded-xl shadow-lg flex flex-col gap-3">
        <button id="draw-boundary-btn" class="w-12 h-12 bg-blue-600 hover:bg-blue-500 rounded-lg flex items-center justify-center" title="Draw Property Boundary"><i class="fas fa-draw-polygon"></i></button>
        <button id="measure-btn" class="w-12 h-12 bg-blue-600 hover:bg-blue-500 rounded-lg flex items-center justify-center" title="Measure Distance"><i class="fas fa-ruler"></i></button>
        <button id="track-path-btn" class="w-12 h-12 bg-green-600 hover:bg-green-500 rounded-lg flex items-center justify-center" title="Start/Stop Tracking Path"><i class="fas fa-shoe-prints"></i></button>
    </div>

    <!-- Find My Location Button -->
    <button id="location-button" class="absolute bottom-4 right-4 z-20 bg-blue-600 hover:bg-blue-500 text-white font-bold w-12 h-12 rounded-full flex items-center justify-center shadow-lg" title="Find My Location">
        <i class="fas fa-location-arrow"></i>
    </button>
    
    <!-- Go-To Compass -->
    <div id="compass">
        <i id="compass-arrow" class="fas fa-arrow-up"></i>
        <div id="compass-distance">-- yd</div>
    </div>

    <!-- Add/Edit Blind Modal -->
    <div id="input-modal" class="hidden absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center z-30">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Blind Details</h3>
            <input type="text" id="blind-name-input" class="w-full bg-gray-700 text-white border-gray-600 rounded-md px-3 py-2 mb-4" placeholder="Blind Name">
            <textarea id="blind-notes-input" class="w-full bg-gray-700 text-white border-gray-600 rounded-md px-3 py-2 mb-4" placeholder="Notes (e.g., best wind, recent sightings)"></textarea>
            <div class="mb-4">
                <label class="block mb-2 text-sm font-medium text-gray-400">Icon Type</label>
                <select id="blind-icon-select" class="w-full bg-gray-700 text-white border-gray-600 rounded-md px-3 py-2">
                    <option value="fa-archway">Rifle Blind</option>
                    <option value="fa-tree">Bow Stand</option>
                    <option value="fa-camera">Game Camera</option>
                    <option value="fa-drumstick-bite">Feeder</option>
                </select>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-button" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancel</button>
                <button id="save-button" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-md font-semibold">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-hunting-map';

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Map Init ---
        // Moved map initialization to a function to be called after the DOM is loaded
        let map;
        function initializeMap() {
            const PROPERTY_COORDS = [31.2492, -99.8523]; // Centered on 11511 Co Rd 2246, Eden, TX
            map = L.map('map').setView(PROPERTY_COORDS, 15);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
            
            // Re-attach event listeners that depend on the map object
            map.on('click', onMapClick);
            map.on(L.Draw.Event.CREATED, (e) => {
                const layer = e.layer;
                if (e.layerType === 'polygon') {
                    if (confirm('Save this as the property boundary?')) {
                        if (boundaryLayer) map.removeLayer(boundaryLayer);
                        boundaryLayer = layer.addTo(map);
                        saveBoundary(layer);
                    }
                } else if (e.layerType === 'polyline') {
                    const distance = (layer.getLatLngs().reduce((acc, latlng, i, arr) => i === 0 ? 0 : acc + latlng.distanceTo(arr[i-1]), 0) * 1.09361).toFixed(1);
                    layer.bindPopup(`Distance: ${distance} yards`).addTo(map).openPopup();
                }
            });
        }


        // --- Global State ---
        let currentUser = null;
        let currentLatLng = null;
        let markers = {};
        let boundaryLayer = null;
        let isTracking = false;
        let trackedPath = [];
        let trackedPolyline = null;
        let watchId = null;
        let userLocationMarker = null;
        let compassTarget = null;

        // --- UI Elements ---
        const inputModal = document.getElementById('input-modal');
        const blindNameInput = document.getElementById('blind-name-input');
        const blindNotesInput = document.getElementById('blind-notes-input');
        const blindIconSelect = document.getElementById('blind-icon-select');
        const saveButton = document.getElementById('save-button');
        const cancelButton = document.getElementById('cancel-button');
        const userInfoDiv = document.getElementById('user-info');
        const locationButton = document.getElementById('location-button');
        const compassDiv = document.getElementById('compass');

        // --- Leaflet Draw ---
        let drawnItems, drawControl;
        function initializeDrawControls() {
            drawnItems = new L.FeatureGroup().addTo(map);
            drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems, remove: true },
                draw: {
                    polygon: { shapeOptions: { color: '#ffca28' } },
                    polyline: true,
                    rectangle: false, circle: false, marker: false, circlemarker: false
                }
            });
        }

        // --- Authentication ---
        async function setupAuthentication() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    userInfoDiv.innerHTML = `Session ID: <span class="font-mono text-xs">${user.uid}</span>`;
                    listenForBlinds();
                    loadBoundary();
                    checkSharedBlind(); // Check for shared links after user is authenticated
                } else { currentUser = null; }
            });
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
            }
        }

        // --- Firestore Logic ---
        function getCollectionPath(coll) { return `/artifacts/${appId}/users/${currentUser.uid}/${coll}`; }

        function listenForBlinds() {
            if (!currentUser) return;
            onSnapshot(collection(db, getCollectionPath('blinds')), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const doc = change.doc;
                    const blind = doc.data();
                    if (change.type === "added" || change.type === "modified") {
                        if (markers[doc.id]) map.removeLayer(markers[doc.id]);
                        addMarkerToMap(blind, doc.id);
                    }
                    if (change.type === "removed") {
                        if (markers[doc.id]) map.removeLayer(markers[doc.id]);
                        delete markers[doc.id];
                    }
                });
            });
        }

        async function saveBlind(data, latLng) {
            if (!currentUser) return;
            const newBlindRef = doc(collection(db, getCollectionPath('blinds')));
            await setDoc(newBlindRef, { ...data, lat: latLng.lat, lng: latLng.lng });
        }
        
        async function deleteBlind(blindId) {
             if (!currentUser) return;
             await deleteDoc(doc(db, getCollectionPath('blinds'), blindId));
        }

        async function saveBoundary(layer) {
            if (!currentUser) return;
            const geoJSON = layer.toGeoJSON();
            await setDoc(doc(db, getCollectionPath('property'), 'boundary'), { geoJSON });
        }

        async function loadBoundary() {
            if (!currentUser) return;
            const docRef = doc(db, getCollectionPath('property'), 'boundary');
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (boundaryLayer) map.removeLayer(boundaryLayer);
                boundaryLayer = L.geoJSON(data.geoJSON, { style: { color: '#ffca28', weight: 3, fillOpacity: 0.1 } }).addTo(map);
            }
        }

        // --- Map Interaction & Features ---
        function addMarkerToMap(blind, blindId) {
            const icon = L.divIcon({
                className: 'custom-blind-icon',
                html: `<i class="fas ${blind.icon || 'fa-archway'}"></i>`,
                iconSize: [30, 30]
            });
            const marker = L.marker([blind.lat, blind.lng], { icon }).addTo(map);
            
            const popupContent = document.createElement('div');
            popupContent.innerHTML = `<strong class="text-lg">${blind.name}</strong><p class="text-gray-300 my-2">${blind.notes || ''}</p>`;
            
            const goToBtn = document.createElement('button');
            goToBtn.innerHTML = '<i class="fas fa-compass mr-2"></i> Go-To';
            goToBtn.className = 'w-full px-3 py-1 bg-green-600 hover:bg-green-500 rounded-md text-sm mb-2';
            goToBtn.onclick = () => { toggleCompass({ lat: blind.lat, lng: blind.lng }); map.closePopup(); };
            popupContent.appendChild(goToBtn);

            const shareBtn = document.createElement('button');
            shareBtn.innerHTML = '<i class="fas fa-share-alt mr-2"></i> Share';
            shareBtn.className = 'w-full px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded-md text-sm mb-2';
            shareBtn.onclick = () => shareBlind(blindId);
            popupContent.appendChild(shareBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> Delete';
            deleteBtn.className = 'w-full px-3 py-1 bg-red-600 hover:bg-red-500 rounded-md text-sm';
            deleteBtn.onclick = () => { if (confirm(`Delete "${blind.name}"?`)) deleteBlind(blindId); };
            popupContent.appendChild(deleteBtn);

            marker.bindPopup(popupContent);
            markers[blindId] = marker;
        }

        function onMapClick(e) {
            currentLatLng = e.latlng;
            blindNameInput.value = '';
            blindNotesInput.value = '';
            blindIconSelect.value = 'fa-archway';
            inputModal.classList.remove('hidden');
            blindNameInput.focus();
        }

        function shareBlind(blindId) {
            const url = new URL(window.location.href);
            url.searchParams.set('blind', blindId);
            navigator.clipboard.writeText(url.toString()).then(() => {
                alert('Share link copied to clipboard!');
            });
        }

        function checkSharedBlind() {
            const urlParams = new URLSearchParams(window.location.search);
            const blindId = urlParams.get('blind');
            if (blindId && currentUser) {
                const blindRef = doc(db, getCollectionPath('blinds'), blindId);
                getDoc(blindRef).then(docSnap => {
                    if (docSnap.exists()) {
                        const blind = docSnap.data();
                        map.setView([blind.lat, blind.lng], 17);
                        markers[blindId]?.openPopup();
                    }
                });
            }
        }
        
        // --- Geolocation & Tracking ---
        function findMyLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.setView([latitude, longitude], 16);
                if (!userLocationMarker) {
                    userLocationMarker = L.marker([latitude, longitude], {
                        icon: L.divIcon({
                            className: 'my-location-icon',
                            html: '<i class="fas fa-crosshairs fa-2x text-blue-400"></i>',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);
                } else {
                    userLocationMarker.setLatLng([latitude, longitude]);
                }
            }, () => alert('Could not get your location.'), { enableHighAccuracy: true });
        }

        function togglePathTracking() {
            isTracking = !isTracking;
            const btn = document.getElementById('track-path-btn');
            if (isTracking) {
                btn.classList.replace('bg-green-600', 'bg-red-600');
                trackedPath = [];
                if (trackedPolyline) map.removeLayer(trackedPolyline);
                trackedPolyline = L.polyline([], { color: 'red' }).addTo(map);
                watchId = navigator.geolocation.watchPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    trackedPath.push([latitude, longitude]);
                    trackedPolyline.addLatLng([latitude, longitude]);
                    if (userLocationMarker) userLocationMarker.setLatLng([latitude, longitude]);
                }, null, { enableHighAccuracy: true });
            } else {
                btn.classList.replace('bg-red-600', 'bg-green-600');
                if (watchId) navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        // --- Compass ---
        function toggleCompass(target) {
            if (compassTarget) {
                compassTarget = null;
                compassDiv.style.display = 'none';
                if (watchId && !isTracking) navigator.geolocation.clearWatch(watchId);
            } else {
                compassTarget = target;
                compassDiv.style.display = 'flex';
                watchId = navigator.geolocation.watchPosition(updateCompass, null, { enableHighAccuracy: true });
            }
        }
        
        function updateCompass(pos) {
            if (!compassTarget) return;
            const { latitude, longitude } = pos.coords;
            const bearing = calculateBearing(latitude, longitude, compassTarget.lat, compassTarget.lng);
            const distance = calculateDistance(latitude, longitude, compassTarget.lat, compassTarget.lng);
            document.getElementById('compass-arrow').style.transform = `rotate(${bearing}deg)`;
            document.getElementById('compass-distance').textContent = `${Math.round(distance * 1093.61)} yd`; // km to yards
        }

        function toRad(deg) { return deg * Math.PI / 180; }
        function toDeg(rad) { return rad * 180 / Math.PI; }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const [phi1, phi2, deltaLambda] = [toRad(lat1), toRad(lat2), toRad(lon2 - lon1)];
            const y = Math.sin(deltaLambda) * Math.cos(phi2);
            const x = Math.cos(phi1) * Math.sin(phi2) - Math.sin(phi1) * Math.cos(phi2) * Math.cos(deltaLambda);
            return (toDeg(Math.atan2(y, x)) + 360) % 360;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const [dLat, dLon] = [toRad(lat2 - lat1), toRad(lon2 - lon1)];
            const [lat1Rad, lat2Rad] = [toRad(lat1), toRad(lat2)];
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1Rad) * Math.cos(lat2Rad);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- Event Listeners ---
        saveButton.addEventListener('click', () => {
            const name = blindNameInput.value.trim();
            if (name && currentLatLng) {
                saveBlind({
                    name,
                    notes: blindNotesInput.value.trim(),
                    icon: blindIconSelect.value
                }, currentLatLng);
                inputModal.classList.add('hidden');
            }
        });

        cancelButton.addEventListener('click', () => inputModal.classList.add('hidden'));
        locationButton.addEventListener('click', findMyLocation);
        document.getElementById('draw-boundary-btn').addEventListener('click', () => new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable());
        document.getElementById('measure-btn').addEventListener('click', () => new L.Draw.Polyline(map, drawControl.options.draw.polyline).enable());
        document.getElementById('track-path-btn').addEventListener('click', togglePathTracking);

        // --- App Start ---
        // Wait for the DOM to be fully loaded before initializing the map
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            initializeDrawControls();
            setupAuthentication();
            findMyLocation(); // Get initial location
        });
    </script>
</body>
</html>
